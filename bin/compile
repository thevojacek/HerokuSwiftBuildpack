#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Sets, how should script behave in case of a failure
set -e
set -o pipefail

# Directories
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Language versions specification
SWIFT_VERSION="4.2.1"
C_LANG_VERSION="7.0.0"

# Downloads URLs
SWIFT_URL="https://swift.org/builds/swift-$SWIFT_VERSION-release/ubuntu1804/swift-$SWIFT_VERSION-RELEASE/swift-$SWIFT_VERSION-RELEASE-ubuntu18.04.tar.gz"
C_LANG_URL="http://llvm.org/releases/$C_LANG_VERSION/clang+llvm-$C_LANG_VERSION-x86_64-linux-gnu-ubuntu-16.04.tar.xz"

# TODO: DOWNLOAD CLANG AND SWIFT ONLY WHEN THEY DO NOT EXIST

# Install Clang
echo "-----> Installing Clang $C_LANG_VERSION"

if ! [ -x "$(command -v clang)" ]; then
    cd $CACHE_DIR
    wget --quiet $C_LANG_URL
    mkdir -p vendor/clang
    tar -C vendor/clang -xvf clang+llvm-$C_LANG_VERSION-x86_64-linux-gnu-ubuntu-16.04.tar.xz
    mv vendor/clang/clang+llvm-$C_LANG_VERSION-x86_64-linux-gnu-ubuntu-16.04/* vendor/clang
    rmdir vendor/clang/clang+llvm-$C_LANG_VERSION-x86_64-linux-gnu-ubuntu-16.04
    rm -f clang+llvm-$C_LANG_VERSION-x86_64-linux-gnu-ubuntu-16.04.tar.xz

    export PATH=$CACHE_DIR/vendor/clang/bin:"${PATH}"
fi

echo "-----> Clang installed"

# export PATH

# Install Swift
echo "-----> Installing Swift $SWIFT_VERSION"

if ! [ -x "$(command -v swift)" ]; then
    cd $CACHE_DIR
    wget --quiet $SWIFT_URL
    mkdir -p vendor/swift
    tar -C vendor/swift -xvf swift-$SWIFT_VERSION-RELEASE-ubuntu18.04.tar.gz
    mv vendor/swift/swift-$SWIFT_VERSION-RELEASE-ubuntu18.04/* vendor/swift
    rmdir vendor/swift/swift-$SWIFT_VERSION-RELEASE-ubuntu18.04
    rm -f swift-$SWIFT_VERSION-RELEASE-ubuntu18.04.tar.gz

    export PATH=$CACHE_DIR/vendor/swift/usr/bin:"${PATH}"
fi

echo "-----> Swift installed"

# Build application
echo "-----> Building application"
cd $BUILD_DIR
swift build -c release --build-path $BUILD_DIR/build
mv $BUILD_DIR/build/release/* $BUILD_DIR
rm -rf $BUILD_DIR/build/*

pwd
ls -la

echo "-----> Application built successfully"

